stages:
  - build
  - release

variables:
  ELECTRON_FORGE_VERSION: "6.0.0"

# Build Linux packages
build_packages:
  stage: build
  image: node:20
  rules:
    - if: $CI_COMMIT_TAG  # Run this job only when a tag is pushed
  script:
    - apt-get update && apt-get install -y dpkg fakeroot jq npm bash fuse cmake libsdl2-dev
    - curl -L -o appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/latest/download/appimagetool-x86_64.AppImage
    - chmod +x appimagetool-x86_64.AppImage
    - chmod +x build.sh
    - source build.sh
  artifacts:
    paths:
      - dist/

# Build Windows packages (Wine + native modules)
build_windows:
  stage: build
  image: electronuserland/builder:wine
  rules:
    - if: $CI_COMMIT_TAG  # Only build on tag
  variables:
    ELECTRON_CACHE: "$CI_PROJECT_DIR/.cache/electron"
    ELECTRON_BUILDER_CACHE: "$CI_PROJECT_DIR/.cache/electron-builder"
    WINEDEBUG: "-all"
  script:
    - echo "Preparing Windows build with native modules..."

    # Install native build deps
    - apt-get update && apt-get install -y jq python3 make g++ cmake

    # Install Node dependencies
    - npm install

    # Rebuild SDL module for Electron (Windows)
    - npm rebuild sdl2-gamecontroller --runtime=electron --target=$(jq -r .electronVersion package.json) --dist-url=https://electronjs.org/headers --arch=win32

    # Build Windows app (NSIS + ZIP)
    - npx electron-builder --win nsis zip

  artifacts:
    paths:
      - dist/

# Create a GitLab release
release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG  # Run this job only when a tag is pushed
  script:
    - echo "Creating release for version $CI_COMMIT_TAG"
  release:  # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: '$CI_COMMIT_TAG'
    description: 'Release $CI_COMMIT_TAG for Linux.'
    assets:
      links:
        - name: "emulsion-${CI_COMMIT_TAG}.deb"
          link_type: "package"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${CI_COMMIT_TAG}/emulsion-${CI_COMMIT_TAG}.deb"
        - name: "emulsion-${CI_COMMIT_TAG}.AppImage"
          link_type: "package"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${CI_COMMIT_TAG}/emulsion-${CI_COMMIT_TAG}.AppImage"
        - name: "emulsion-${CI_COMMIT_TAG}.exe"
          link_type: "package"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${CI_COMMIT_TAG}/emulsion-${CI_COMMIT_TAG}.exe"
        - name: "emulsion-${CI_COMMIT_TAG}.win.zip"
          link_type: "package"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${CI_COMMIT_TAG}/emulsion-${CI_COMMIT_TAG}.win.zip"

  dependencies:
    - upload_assets

# Upload assets to GitLab Generic Packages Registry
upload_assets:
  stage: release
  image: curlimages/curl:latest  # Use curl to upload files
  rules:
    - if: $CI_COMMIT_TAG  # Run this job only when a tag is pushed
  script:
    - echo "Uploading assets for tag $CI_COMMIT_TAG"
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "dist/emulsion-${CI_COMMIT_TAG}.deb" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${CI_COMMIT_TAG}/emulsion-${CI_COMMIT_TAG}.deb"
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "dist/emulsion-${CI_COMMIT_TAG}.AppImage" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${CI_COMMIT_TAG}/emulsion-${CI_COMMIT_TAG}.AppImage"
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "dist/emulsion-${CI_COMMIT_TAG}.win.zip" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${CI_COMMIT_TAG}/emulsion-${CI_COMMIT_TAG}.win.zip"


  dependencies:
    - build_packages
